-- disable the maintenance daemon, prevent it from making any connections
ALTER SYSTEM SET citus.distributed_deadlock_detection_factor TO -1;
ALTER SYSTEM SET citus.recover_2pc_interval TO -1;
ALTER SYSTEM set citus.enable_statistics_collection TO false;
SELECT pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)

-- add the workers
SELECT master_add_node('localhost', :worker_1_port);  -- the second worker
                  master_add_node                  
---------------------------------------------------
 (1,1,localhost,57637,default,f,t,primary,default)
(1 row)

SELECT master_add_node('localhost', :worker_2_port + 2);  -- the first worker, behind a mitmproxy
                  master_add_node                  
---------------------------------------------------
 (2,2,localhost,57638,default,f,t,primary,default)
(1 row)

CREATE TABLE test (a int, b int);
SELECT create_distributed_table('test', 'a');
 create_distributed_table 
--------------------------
 
(1 row)

\copy (SELECT 'conn.after("BEGIN").kill()') TO 'mitmproxy.pipe' (format csv);
-- eventually: SELECT citus.mitmproxy('conn.after("BEGIN").kill()');
BEGIN;
UPDATE test SET b = 2 WHERE a = 2;
ERROR:  server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.
CONTEXT:  while executing command on localhost:9702
ROLLBACK;
